#!/usr/bin/env python

import os
import sys
import optparse

import csv
import json


import datetime


def date_to_episode_code(date):

    # print "date_to_episode_code", date

    for t in ('(1)', '(approx)'):
        date = date.replace(t, '')

    date = date.strip()

    d = None

    for fmt in ("%d %B %Y", "%B %Y", "%Y"):
        # print "trying", fmt
        try:
            d = datetime.datetime.strptime(date, fmt)
            break
        except Exception, e:
            pass

    # print d

    if not d:
        print "FAILED TO GET DATE FROM:", date
        raise Exception("can't parse date string: "+date)
        return 0

    return int(d.strftime("%Y%m"))



csv.register_dialect('tsv', delimiter='\t')


if False:
    f = open("deaths.tsv", 'rt')
    try:
        reader = csv.reader(f, dialect='tsv')
        for row in reader:
            d = date_to_episode_code(row[1])
            print json.dumps({
                "source":row[0], "target":"Dead", "starting":d,
                "ending":999999,
                "label":row[2], "type":"B",
                }),","
    except Exception, e:
        print "failed on row:", row
        raise
    finally:
        f.close()

if False:
    f = open("weddings.tsv", 'rt')
    try:
        reader = csv.reader(f, dialect='tsv')
        for row in reader:
            d = date_to_episode_code(row[0])
            print json.dumps({
                "source":row[1], "target":row[2], "starting":d,
                "ending":999999,
                "label":row[3], "type":"C",
                }),","
    except Exception, e:
        print "failed on row:", row
        raise
    finally:
        f.close()


if True:
    f = open("aborted-weddings.tsv", 'rt')
    try:
        reader = csv.reader(f, dialect='tsv')
        for row in reader:
            d = date_to_episode_code(row[0])
            print json.dumps({
                "source":row[1], "target":row[2], "starting":d,
                "ending":999999,
                "label":row[3], "type":"C",
                }),","
    except Exception, e:
        print "failed on row:", row
        raise
    finally:
        f.close()




